<div class="flex flex-col min-h-dvh bg-black text-white relative overflow-hidden">

  <app-notifications [notifications]="(notifications$ | async)"
    (remove)="onRemoveNotification($event)"></app-notifications>

  <!-- Navbar -->
   <header class="flex items-center mt-1 justify-between panel-gradient-bg rounded-lg shrink-0 mx-1 sm:mx-3 px-3 lg:px-0 pt-2 lg:pt-1 pb-2" #headerRef>
      <div class="lg:w-[21.25%] text-center">
        <img class="w-28 lg:w-32 mx-auto logo-img"
        [src]="'images/logo' + (isMobile ? '_mobile' : '') + '.png'" >
      </div>

      <!-- DESKTOP JACKPOT METERS -->
      <div class="flex-1 self-end text-center hidden lg:flex sm:items-center gap-2 md:gap-4 lg:gap-8 sm:justify-center px-5" *ngIf="hasJackpotFeature">
          <ng-container *ngTemplateOutlet="jackpotTemplate; context: { compact: false }"></ng-container>
      </div>

      <div class="lg:w-[18.5%] flex items-center lg:pr-4 justify-end gap-6 lg:gap-10">
        <!-- <img src="assets/icons/home.png" class="w-4 md:w-5 cursor-pointer hover:opacity-80"> -->
        <img src="assets/icons/chat.png" class="btn w-5 md:w-6 inline-block cursor-pointer hover:opacity-80" *ngIf="betSettings?.chat"
        (click)="toggleChat()">
        <img src="assets/icons/stat.png" class="btn w-4 lg:hidden inline-block cursor-pointer hover:opacity-80"
        (click)="toggleMobileBetList()">
        <img src="assets/icons/menu.png" (click)="toggleMenu()" class="btn w-4 md:w-5 cursor-pointer hover:opacity-80">
      </div>
  </header>

  <!-- MOBILE/TABLET JACKPOT METERS-->
  <div class="text-center flex lg:hidden items-center gap-1 mx-1 sm:mx-3 mt-2 mob-jackpot-container" *ngIf="hasJackpotFeature" #mobJackpotRef>
    <ng-container *ngTemplateOutlet="jackpotTemplate; context: { compact: true }"></ng-container>
  </div>

  <!-- Main -->
  <main class="flex lg:flex-row flex-col flex-grow px-1 sm:px-3 py-2 main-container">

    <!-- Bet List (Desktop & Mobile) -->
    <div  #betlistRootDiv
      class="lg:w-[21.25%] min-w-[320px] fixed lg:relative
              bottom-0 left-0 right-0 z-50
              lg:mx-0 mx-1 sm:mx-3
              lg:panel-gradient-bg bg-[#222] py-3 rounded-lg"
      [style.maxHeight]="isMobile ? '100%' : betListHeight + 'px'"
      [style.height]="isMobile ? 'calc(100% - 51px)' : null"
      [class.translate-y-full]="!isMobileBetListOpen && isMobile"
      [class.translate-y-0]="isMobileBetListOpen && isMobile">

      <!-- Mobile Close -->
      <span *ngIf="isMobileBetListOpen"
        (click)="isMobileBetListOpen = false"
        class="btn pointer-events-auto lg:px-5 lg:pt-5 lg:pb-5 px-3 pt-[13px] pb-4 bg-[#222]
            cursor-pointer -translate-y-full
            absolute right-[40px] top-[4px] lg:top-2">  
        <img src="assets/icons/close.png" class="w-4 mb-[5px] lg:mb-0 lg:w-5">
      </span>

      <app-bet-list class="flex-grow min-h-0"
        [boomers]="(boomers$ | async)"
        [player]="(player$ | async)"
        [totalBetCount]="(totalBetCount$ | async) || 0"
        [cashoutStats]="(cashoutStats$ | async) || {cashoutAmount: 0, cashoutCount: 0}"
        [subtabs_stats_last_history]="(roundHistory$ | async) || []"
        [subtabs_best_cashed]="(bestCashed$ | async)?.data || []"
        [subtabs_best_wins]="(bestWins$ | async)?.data || []"
        [subtabs_best_result]="(bestResult$ | async)?.data || []"
        [subtabs_stats_stats_info]="(stats$ | async) || null"
        [provider_currency]="(providerCurrency$ | async) || ''">
      </app-bet-list>
    </div>

    <!-- Game Area -->
    <div class="lg:pl-1 relative lg:w-[calc(100%-320px)] gameArea"
        [ngClass]="isMobile && isLandscape ? 'gap-2 flex flex-row' : ''"
    #middleGameAreaContainer>

      <div *ngIf="showGameView$ | async" class="midArea flex lg:pl-1"
        [ngClass]="isMobile && isLandscape ? 'w-1/2' : ''">
        
        <app-game-view 
          [game]="(game$ | async) || undefined" 
          [canvas]="(canvas$ | async) || undefined" 
          [style.--gv-height.px] = "gameViewHeight"
          [ngClass]="(isChatVisible$ | async) || (isMenuVisible$ | async) ? 'lg:w-[55%]' : 'lg:w-full'">
        </app-game-view>

        <!-- Chat Panel -->
        <div *ngIf="isChatVisible$ | async"
          class="lg:w-[31.1%] lg:ml-2 lg:mr-0 sm:mx-3 ml-1 mr-1 panel-gradient-bg rounded-lg px-2 py-2
                fixed lg:static top-[50px] left-0 right-0 bottom-0 z-40 lg:z-auto"
          [style.maxHeight]="isMobile ? '100%' : gameViewHeight + 'px'"
          [style.height]="isMobile ? 'calc(100% - 55px)' : null">
          <!-- <div class="mb-3 flex gap-2 items-center">
            <img src="assets/icons/chat.png" alt="" class="h-3 opacity-75">
            <span class="text-xs font-semibold text-[var(--text-secondary)]">{{ 'chat.chat-title' | translate  }}</span>
            <span (click)="toggleChat()" class=" inline px-2 py-1 cursor-pointer opacity-70 hover:opacity-100 absolute right-1 top-2">
              <img src="assets/icons/close.png" class="w-2.5 lg:w-3">
            </span>
          </div> -->
          <div class="h-[calc(100%)]">
            <app-chat-box [messages]="(messages$ | async) || []"></app-chat-box>
          </div>
        </div>

        <!-- Dummy Panel to take width when menu is open and chat is not active so the menu panel does not come on top of game area -->
        <div *ngIf="(!(isChatVisible$ | async)) && (isMenuVisible$ | async) && !isMobile"
          class="lg:w-[31.1%] lg:mx-1.5 opacity-0 rounded-lg lg:static "
          [style.maxHeight]="gameViewHeight + 'px'">
        </div>
      </div>

      <!-- Bet Panel -->
      <div #betPanelRef class="betListArea lg:pl-1 lg:pt-2"
        [ngClass]="isMobile && isLandscape ? 'w-1/2 pt-0' : 'pt-2'">
        <app-bet-panel [virtualKeyboardHeight] = "virtualKeyboardHeight" [toggleMenu]="toggleMenu.bind(this)" [menuOpen$]="isMenuVisible$" [isSingleBetEnabled$]="isSingleBetEnabled$" [providerCurrency] = "(providerCurrency$ | async) || 'USD'"></app-bet-panel>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="px-1 sm:px-3 py-1 bg-black" #footerRef>
    <div class="flex justify-between items-center gap-2 mb-2 bet-balance-container">
      <app-player-balance [player]="(player$ | async)" [providerInfo]="(providerInfo$ | async)"></app-player-balance>
      <app-total-bet [betPanels]="(betPanels$ | async)" [providerInfo]="(providerInfo$ | async)"
        [phase]="(phase$ | async)"></app-total-bet>
    </div>
    <div class="text-center relative round-history-container">
      <app-round-history (openModalClicked)="openFairnessModal($event)" [history]="(roundHistory$ | async) || []"></app-round-history>
      <div class="absolute top-0 bottom-0 right-0 w-12 pointer-events-none bg-gradient-to-l from-[#000000cc] to-transparent"></div>
    </div>
  </footer>

  <!-- MENU PANEL POPUP -->
  <div *ngIf="isMenuVisible$ | async"
    class="bg-[#222] border border-[#474747] rounded-lg rounded-tr-none px-1 py-2 shadow-lg shadow-black
            lg:w-[18.4%] mx-1 sm:mx-3 lg:shadow-none
            w-[full] absolute top-[51px] lg:top-[93px] left-0 sm:left-[25%] lg:left-auto right-0 bottom-1 sm:bottom-[115px] z-50"
    [style.maxHeight.px]="!isMobile ? gameViewHeight : 'auto'">

    <span (click)="toggleMenu()" class="border border-b-0 border-[#474747] btn lg:px-5 lg:pt-[27px] pt-[13px] lg:pb-10 px-3 py-4 cursor-pointer absolute -right-[1px] -z-0 -translate-y-full rounded-tr-[5px] top-0 lg:top-0 bg-[#222]">
      <img src="assets/icons/close.png" class="w-4 lg:w-5 mb-[2px] lg:mb-[2px]">
    </span>
    
    <div class=" overflow-y-auto h-full">
      <menu-panel
        [isChatVisible$]="isChatVisible$"
        [isMusicEnabled$]="isMusicEnabled$"
        [isSoundEnabled$]="isSoundEnabled$"
        [isAnimationEnabled$]="isAnimationEnabled$"
        [isSingleBetEnabled$]="isSingleBetEnabled$"
        [player$]="player$ | async"
        [providerInfo]="(providerInfo$ | async)"

        (toggleChatClicked)="toggleChat()"
        (toggleMusicClicked)="toggleMusic()"
        (toggleSoundClicked)="toggleSound()"
        (toggleAnimationClicked)="toggleAnimation()"
        (toggleSingleBetClicked)="toggleSingleBet()"
        (openModalClicked)="openModal($event)"
      ></menu-panel>
    </div>
  </div>

  <!-- All Modals -->
  <div *ngIf="isModalOpen"
    class="fixed inset-0 z-50">
    <ng-container [ngSwitch]="activeModal">
      <edit-avatar *ngSwitchCase="'editAvatar'" (close)="closeModal()" [player$]="player$ | async"></edit-avatar>
      <history-modal *ngSwitchCase="'history'" (close)="closeModal()" (openRound)="openRoundDetail($event)"></history-modal>
      <quick-guide-modal *ngSwitchCase="'quickGuide'" (close)="closeModal()"></quick-guide-modal>
      <payouts-modal *ngSwitchCase="'payouts'" [providerCurrency] = "(providerCurrency$ | async) || 'USD'" [betSettings] = "betSettings" (close)="closeModal()"></payouts-modal>
      <provably-fair-settings-modal *ngSwitchCase="'provablyFair'" (close)="closeModal()"
      [clientSeed] = "(clientSeed$ | async)"
      [serverSeedHash] = "(serverSeedHash$ | async)"
      ></provably-fair-settings-modal>
      <game-help-modal *ngSwitchCase="'gameHelp'" [providerCurrency] = "(providerCurrency$ | async) || 'USD'" (close)="closeModal()"></game-help-modal>
      
      <result-fairness *ngSwitchCase="'resultFairness'"
      [selectedRound] = "selectedRound"
      [selectedRoundId] = "selectedRoundId"
      [fromHistoryDetails] = "fromHistoryDetails"
      (close)="closeModal()"></result-fairness>
    </ng-container>
  </div>

  <!-- Jackpot Meters -->
  <ng-template #jackpotTemplate let-compact="compact">
    <div
      #grandJackpotRef
      class="jackpot-box lg:flex-1 jackpot-grand"
      (mouseenter)="showTooltip(
                  $event,
                  'grand')"
      (mouseleave)="hideTooltip()"
      [ngClass]="compact ? 'flex-1' : 'min-w-[140px]'"
    >
      <div class="title" [ngClass]="compact ? 'text-sm' : 'md:text-lg'">{{ 'jackpot.grand' | translate  }}</div>
      <div class="amount" [ngClass]="compact ? 'text-xs' : 'md:text-base'">
        <span>{{ getCurrencySym((providerCurrency$ | async) || 'USD') }}</span>

          <ng-container *ngIf="jackpotWinType === 'grand' && jackpotWinAmount !== null; else odometerGrand">
            {{ jackpotWinAmount | number:'1.2-2':'en' }}
          </ng-container>

          <ng-template #odometerGrand>
            <tm-ng-odometer
              [number]="jackpotAmounts?.grand || 0"
              [format]="'(,ddd).dd'"
              [value]="jackpotAmounts?.grand || 0"
              [theme]="'default'">
            </tm-ng-odometer>
          </ng-template>
      </div>
    </div>
    
    <div
      #majorJackpotRef
      class="jackpot-box lg:flex-1 jackpot-major"
      (mouseenter)="showTooltip($event, 'major')"
      (mouseleave)="hideTooltip()"
      [ngClass]="compact ? 'flex-1' : 'min-w-[140px]'"
    >
      <div class="title" [ngClass]="compact ? 'text-sm' : 'md:text-lg'">{{ 'jackpot.major' | translate  }}</div>
      <div class="amount" [ngClass]="compact ? 'text-xs' : 'md:text-base'">
          <span>{{ getCurrencySym((providerCurrency$ | async) || 'USD') }}</span>
          <ng-container *ngIf="jackpotWinType === 'major' && jackpotWinAmount !== null; else odometerMajor">
            {{ jackpotWinAmount | number:'1.2-2':'en' }}
          </ng-container>

          <ng-template #odometerMajor>
            <tm-ng-odometer
              [number]="jackpotAmounts?.major || 0"
              [format]="'(,ddd).dd'"
              [value]="jackpotAmounts?.major || 0"
              [theme]="'default'">
            </tm-ng-odometer>
          </ng-template>
      </div>
    </div>

    <div
      #minorJackpotRef
      class="jackpot-box lg:flex-1 jackpot-mega"
      (mouseenter)="showTooltip($event, 'minor')"
      (mouseleave)="hideTooltip()"
      [ngClass]="compact ? 'flex-1' : 'min-w-[140px]'"
    >
      <div class="title" [ngClass]="compact ? 'text-sm' : 'md:text-lg'">{{ 'jackpot.mega' | translate  }}</div>
      <div class="amount" [ngClass]="compact ? 'text-xs' : 'md:text-base'">
          <span>{{ getCurrencySym((providerCurrency$ | async) || 'USD') }}</span>
          <ng-container *ngIf="jackpotWinType === 'minor' && jackpotWinAmount !== null; else odometerMinor">
            {{ jackpotWinAmount | number:'1.2-2':'en' }}
          </ng-container>

          <ng-template #odometerMinor>
            <tm-ng-odometer
              [number]="jackpotAmounts?.minor || 0"
              [format]="'(,ddd).dd'"
              [value]="jackpotAmounts?.minor || 0"
              [theme]="'default'">
            </tm-ng-odometer>
          </ng-template>
      </div>
    </div>
    
    <div
      #miniJackpotRef
      class="jackpot-box lg:flex-1 jackpot-mini"
      (mouseenter)="showTooltip($event, 'mini')"
      (mouseleave)="hideTooltip()"
      [ngClass]="compact ? 'flex-1' : 'min-w-[140px]'"
    >
      <div class="title" [ngClass]="compact ? 'text-sm' : 'md:text-lg'">{{ 'jackpot.mini' | translate  }}</div>
      <div class="amount" [ngClass]="compact ? 'text-xs' : 'md:text-base'">
          <span>{{ getCurrencySym((providerCurrency$ | async) || 'USD') }}</span>
          <ng-container *ngIf="jackpotWinType === 'mini' && jackpotWinAmount !== null; else odometerMini">
            {{ jackpotWinAmount | number:'1.2-2':'en' }}
          </ng-container>

          <ng-template #odometerMini>
            <tm-ng-odometer
              [number]="jackpotAmounts?.mini || 0"
              [format]="'(,ddd).dd'"
              [value]="jackpotAmounts?.mini || 0"
              [theme]="'default'">
            </tm-ng-odometer>
          </ng-template>
      </div>
    </div>
  </ng-template>

  <!-- Jackpot Tooltip -->
  <div
    *ngIf="tooltip.visible"
    class="fixed z-50 bg-[#222] text-white rounded shadow-lg px-3 py-3"
    [style.left]="tooltip.left"
    [style.right]="tooltip.right"
    [style.top.px]="tooltip.y"
    [style.minWidth.px]="tooltip.width"
  >
    <div class="flex justify-between items-center gap-1 sm:gap-2 lg:gap-4 
                text-[8px] sm:text-[10px] pb-2 mb-2 border-b border-gray-700">
      <span class="font-semibold">{{ 'jackpot.last' | translate  }} {{ ('jackpot.' + tooltip.type) | translate }}</span>
      <span class="opacity-90">{{ tooltip.date }}</span>
    </div>
    <div class="text-xs text-center sm:text-sm md:text-lg font-bold">
      {{ getCurrencySym((providerCurrency$ | async) || 'USD') }}{{ tooltip.amount | number:'1.2-2':'en' }}
    </div>

    <!-- Arrow -->
    <div
      class="absolute -top-1 w-2 h-2 bg-[#222] rotate-45"
      [style.left.%]="45"
    >
    </div>
  </div>
</div>


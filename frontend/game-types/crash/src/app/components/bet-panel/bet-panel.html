<div class="grid grid-cols-1 lg:grid-cols-2 gap-2 md:gap-4 h-full w-full" id="betPanelInnerRef">
  <!-- Bet Panels -->
  <ng-container *ngFor="let panel of panels; let i = index">
    <div class="bet-panel__container panel-gradient-bg p-1 pt-1.5 rounded-lg self-center relative h-fit min-w-[250px]">
      
      <!-- Close Button -->
      <!-- <button *ngIf="panels.length > 1 && i > 0" (click)="removePanel(panel)"
        [ngClass]="{'disabled': panel.betId || panel.order==='first'}"
        class="bet-panel__remove-btn text-black text-lg leading-none absolute -top-1.5 right-0 px-1 pb-0.5 pt-0 bg-white rounded-md z-10">
        &times;
      </button> -->

      <div class="inner-container mx-auto h-full flex flex-col justify-center">
        <!-- Bet Amount Section -->
        <div class="mb-2 flex gap-2 items-stretch betPanelBtnsFlex">
          <div class="bet-btns w-1/2">
            <!-- Up/Down Arrows -->
            <div class="flex items-stretch gap-1">
              <button class="rounded-[4px] px-2 pt-0.5 opacity-90 betDecBtn" data-action="betDec"
                [disabled]="panel.betId || panel.autoBet || panel.betAmount <= minBet || panel.preBet"
                [ngClass]="{
                  'danger-btn-bg': !(panel.betId || panel.autoBet || panel.betAmount <= minBet || panel.preBet),
                  'disabled-gradient-bg': (panel.betId || panel.autoBet || panel.betAmount <= minBet || panel.preBet)
                }"
                (click)="decreaseBet(i)"
              >
                <img src="assets/icons/bet_down.png" class="w-5">
              </button>
              <input
                #betInput
                step="any"
                [type]="virtualKeyboardAllowed ? 'text' : 'number'"
                [readonly]="virtualKeyboardAllowed"
                inputmode="decimal"
                [value]="(panel.betAmount).toFixed(2)"
                (click)="openKeyboard(panel.betAmount, i)"
                (keydown)="preventInvalidInput($event)"
                (blur)="onBlurBetAmountInput(betInput, i)"
                [disabled]="panel.betId !== null  || panel.preBet"
                class="betInput text-center block input focus:outline-none bg-black text-sm md:text-base font-semibold rounded-[4px] px-2 py-1 md:py-1.5 w-full" />

              <button class="rounded-[4px] px-2 opacity-90 betIncBtn" data-action="betInc"
                  [disabled]="panel.betId || panel.autoBet || panel.betAmount >= maxBet || panel.preBet"
                  [ngClass]="{
                    'success-btn-bg': !(panel.betId || panel.autoBet || panel.betAmount >= maxBet || panel.preBet),
                    'disabled-gradient-bg': (panel.betId || panel.autoBet || panel.betAmount >= maxBet || panel.preBet)
                  }"
                (click)="increaseBet(i)"
                >
                  <img src="assets/icons/bet_up.png" class="w-5">
              </button>
            </div>

            <!-- Bet increment buttons -->
            <div class="mt-2 grid grid-cols-2 gap-2 incBtns">
              <button *ngFor="let amt of betValueIncrements"
                [disabled]="panel.betId || panel.autoBet || panel.preBet || (phase$ | async) === 'WAITING'"
                class="text-white rounded-[4px] py-1 md:py-1.5 font-bold btn-gradient-bg text-xs md:text-sm"
                (click)="onIncrementClick(i, amt)">
                {{ amt }}
              </button>
            </div>
          </div>

          <div class="action-btns w-1/2">
            <!-- Confirm Bet -->
            <ng-container *ngIf="phase$ | async as phase">
              <ng-container *ngIf="providerInfo$ | async as providerInfo">
                <button
                  (click)="placeBet(panel, phase === 'PLAYING' || phase === 'DISTRIBUTING')"
                  *ngIf="panel.betId === null && !panel.preBet"
                  class="action-btn success-gradient-bg rounded-[4px]"
                  [ngClass]="{ 'disabled-gradient-bg': phase === 'WAITING' || panel.betId || panel.busy }"
                  [disabled]="phase === 'WAITING' || panel.betId || panel.busy">

                  <span class="inline-block font-semibold text-xs md:text-sm">
                    {{ 'bet-panel.confirm-bet' | translate }}
                  </span>

                  <h2 class="text-lg md:text-2xl font-bold">
                    {{ panel.betAmount | number:'1.2-2':'en' }}
                    {{ providerInfo?.currency }}
                  </h2>
                </button>
              </ng-container>
            </ng-container>

            <!-- Cancel Bet -->
            <button
              *ngIf="panel.betId !== null && ((phase$ | async) === 'BETTING' || (phase$ | async) === 'WAITING')"
              (click)="cancelBet(panel)"
              [disabled]="(phase$ | async) === 'WAITING' || panel.busy"
              [ngClass]="{ 'disabled-gradient-bg': (phase$ | async) === 'WAITING' || panel.busy}"
              class=" action-btn danger-gradient-bg rounded-[4px]">
              <span class="inline-block font-semibold text-xs md:text-sm"> {{ 'bet-panel.cancel-bet' | translate  }} </span>
              <h2 class="text-lg md:text-2xl font-bold">
                {{ panel.betAmount | number:'1.2-2':'en' }}
                {{ (providerInfo$ | async)?.currency }}</h2> 
            </button>

            <!-- Cashout -->
            <button
              *ngIf="panel.betId !== null && (phase$ | async) === 'PLAYING'"
              (click)="cashoutBet(panel)"
              [ngClass]="{ 'disabled-gradient-bg': panel.busy}"
              [disabled]="panel.busy"
              class="action-btn warning-gradient-bg rounded-[4px]">
              <span class="inline-block font-semibold text-xs md:text-sm"> {{ 'bet-panel.cashout' | translate  }} </span>
              <h2 class="text-lg md:text-2xl font-bold">
                {{ (panel.betAmount * ((multiplier$ | async) || 1)) | number:'1.2-2':'en' }}
                {{ (providerInfo$ | async)?.currency }}
              </h2> 
            </button>
            
            <!-- Pre Bet -->
            <button
              *ngIf="panel.preBet"
              [ngClass]="{ 'disabled-gradient-bg': panel.busy}"
              [disabled]="(phase$ | async) === 'WAITING' || panel.busy"
              (click)="cancelPreBet(panel)"
              class=" action-btn danger-gradient-bg rounded-[4px]">
              <span class="inline-block font-semibold text-xs md:text-sm"> {{ 'bet-panel.cancel-bet' | translate  }} </span>
                <p class="text-xs text-white/75 font-semibold mt-1">{{ 'bet-panel.wait-next' | translate  }}</p>
            </button>
          </div>
        </div>

        <!-- Bottom Section: AutoPlay and AutoCashout -->
        <div class="flex items-center justify-between">
          <!-- Auto Play -->

          <div class="items-center flex ml-1">
            <img
              src="assets/icons/undo.png"
              (click)="canUndo(panel) && undoBet(panel, i)"
              [ngClass]="{
                'opacity-40 cursor-default': !canUndo(panel),
                'btn cursor-pointer hover:opacity-80': canUndo(panel)
              }"
              class="w-[22px] mr-3 md:mr-4 undo-img"
            />
            
            <div class="relative inline-block">
              <img 
                [attr.role]="activePopupIndex === i ? null : 'button'"
                [src]="'assets/icons/autoplay_' + (panel.autoBet ? 'on' : 'off') + '.png'"
                [id]="'autoPlay-' + i"
                class="autobet-img w-[22px] cursor-pointer"
                [ngClass]="{ 'opacity-40 hover:opacity-40': (phase$ | async) === 'WAITING',
                'hover:opacity-80': (phase$ | async) !== 'WAITING'}"
                (click)="openAutoplayPopup(i)">

              <div *ngIf="activePopupIndex === i" class="absolute -left-9 -top-6 -translate-y-full sm:min-w-96 min-w-[320px] w-full mt-2 z-50 autobet-popup">
                <div class="relative bg-[#292925] text-white rounded-[4px] shadow-xl shadow-[#000] px-2 py-4 sm:p-4">
                  
                  <!-- Bottom Triangle  -->
                  <div class="autobet-triangle absolute -bottom-2 left-11 -translate-x-1/2 w-0 h-0 
                              border-l-8 border-r-8 border-t-8 border-transparent border-t-[#292925]">
                  </div>

                  <!-- Header -->
                  <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-xs"> {{ 'bet-panel.autoplay' | translate  }} </h3>
                    <button (click)="closePopup()" class="text-lg outline-none active:outline-none mr-1"><img src="assets/icons/close.png" class="w-3" alt=""></button>
                  </div>

                  <p class="text-xs mt-1 mb-3">{{ 'bet-panel.bet-per-round' | translate  }}:
                    <span class="text-white font-bold">
                          {{ getCurrencySym(providerCurrency || 'USD') }}{{ panel.betAmount | number:'1.2-2':'en' }}
                    </span>
                  </p>

                  <!-- Options -->
                  <div *ngIf="!panel.autoBet" class="grid grid-cols-2 gap-2">
                    <button 
                      *ngFor="let option of autoBetCountOptions"
                      data-action="autoPlayStartStop"
                      class="btn-gradient-bg hover:opacity-80 rounded-sm pt-1 pb-2 px-3 text-left"
                      (click)="selectAutoplayRounds(i, option)">
                      <div class="flex justify-between items-center">
                        <div class="flex-grow">
                          <div class="flex items-baseline">
                              <span class="sm:text-xl text-lg text-[var(--text-primary)] font-bold">{{ option }}</span>
                              <span class="text-[10px] ml-1">{{ 'bet-panel.rounds' | translate  }}</span>
                          </div>
                          <p class= "text-[10px] font-semibold text-[#949494]">
                            {{ 'bet-panel.total' | translate  }}
                            <span class="text-white">
                            {{ getCurrencySym(providerCurrency || 'USD') }}{{ option * panel.betAmount | number:'1.2-2':'en' }}
                            </span>
                          </p>
                        </div>
                        <img src="assets/icons/autoplay_start.png" class="w-6 mt-2">
                      </div>
                    </button>
                  </div>

                  <!-- Stop Button -->
                  <div *ngIf="panel.autoBet" class="">
                    <div data-action="autoPlayStartStop"
                        class="btn-gradient-bg cursor-pointer mb-1 hover:opacity-80 rounded-sm pt-1 pb-2 px-3 w-full btn"
                        (click)="stopAutoplay(i)">
                        <div class="sm:text-lg text-base" data-action="autoPlayStartStop">
                          <span class="text-[var(--text-primary)] font-bold" data-action="autoPlayStartStop">{{panel.remainingAutoBetCount}}</span>
                          <span class="text-[var(--text-secondary)]" data-action="autoPlayStartStop"> / {{panel.totalAutoBetCount}}</span>
                          <span class="text-sm text-[var(--text-secondary)] ml-2 lowercase" data-action="autoPlayStartStop">{{ 'bet-panel.rounds' | translate  }}</span>
                        </div>
                        <div class="flex items-center -mt-2" data-action="autoPlayStartStop">
                          <div class="h-[4px] flex-grow relative bg-black" data-action="autoPlayStartStop">
                            <span class="absolute top-0 left-0 bottom-0 bg-[var(--text-primary)]" data-action="autoPlayStartStop" [style.width.%]="(panel.remainingAutoBetCount / panel.totalAutoBetCount) * 100"></span>
                          </div>
                          <img src="assets/icons/autoplay_stop.png" data-action="autoPlayStartStop" class="w-6 ml-3 mb-1">
                        </div>
                    </div>
                     <div class="grid grid-cols-3 gap-1">
                      <button 
                        *ngFor="let incOption of autoBetCountIncrements"
                        class="btn-gradient-bg hover:opacity-80 rounded-sm py-1 sm:px-3 px-2 text-left"
                        (click)="increaseAutoplayRounds(i, incOption)">
                        <div class="flex items-baseline">
                          <span class="sm:text-xl text-base text-[var(--text-primary)] font-bold">+{{ incOption }}</span>
                          <span class="text-[10px] text-white ml-1">{{ 'bet-panel.rounds' | translate  }}</span>
                        </div>
                        <p class="text-white text-[10px] font-semibold">
                          {{ getCurrencySym(providerCurrency || 'USD') }}{{ incOption * panel.betAmount | number:'1.2-2':'en' }}
                        </p>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
            
            <ng-container *ngIf="panel.autoBet">
              <p class="ml-1 sm:ml-1.5 text-[12px] sm:text-xs font-bold text-[var(--text-primary)]">{{panel.remainingAutoBetCount}}</p>
            </ng-container>
          </div>

          <!-- Auto Cashout -->
          <label class="flex items-center relative">
            <div class="text-[9px] md:text-[10px] text-white whitespace-nowrap">{{ 'bet-panel.auto-cashout' | translate  }}</div>
              
            <img data-action="autoCashToggle" role="button"
              [src]="'assets/icons/toggle_' + (panel.autoCashoutEnabled ? 'on' : 'off') + '.png'"
              class="w-9 ml-1.5 cashout-btn btn"
              [ngClass]="getToggleBtnClasses(panel)"
              (click)="onToggleAutoCashout($event, i)">

              <input
                #cashoutInput
                [type]="virtualKeyboardAllowed ? 'text' : (isEditingCashoutInput ? 'number' : 'text')"
                [readonly]="virtualKeyboardAllowed"
                [value]="
                  virtualKeyboardAllowed
                    ? panel.autoCashout.toFixed(2) + 'x'
                    : (isEditingCashoutInput
                        ? panel.autoCashout.toFixed(2)
                        : panel.autoCashout.toFixed(2) + 'x')
                "
                (click)="onCashoutClick(cashoutInput, i)"
                (focus)="onFocusCashoutInput(cashoutInput, i)"
                (blur)="onBlurCashoutInput(cashoutInput, i)"
                (keydown)="preventInvalidInput($event)"
                [disabled]="panel.betId || !panel.autoCashoutEnabled || panel.preBet"
                step="any"
                min="minAutoCashoutMultiplier"
                inputmode="decimal"
              class="bg-black text-white text-center ml-1 rounded py-1 pl-2 px-6 autocashout-input text-xs font-bold min-w-8 max-w-24" />
            <img src="assets/icons/edit.png" class="w-3 bg-black absolute right-1.5 top-1/2 transform -translate-y-1/2" [ngClass]="{'disabled': !panel.autoCashoutEnabled}">
          </label>
        </div>
      </div>
    </div>
  </ng-container>

  
  <!-- Keyboard -->
  <app-bet-keyboard
    *ngIf="showKeyboard"
    [mode]="activeKeyboardMode"
    [value]="keyboardValue"
    [panelIndex]="activePanelIndex"
    [minNumber]="activeKeyboardMode === 'bet' ? minBet : minAutoCashoutMultiplier"
    [maxNumber]="activeKeyboardMode === 'bet' ? maxBet : maxAutoCashoutMultiplier"
    [providerCurrency] = "providerCurrency"
    [maxHeightFromPanel]="virtualKeyboardHeight"
    (apply)="onKeyboardApply($event)"
    (valueChange)="onKeyboardValueChange($event)"
    (close)="showKeyboard = false">
  </app-bet-keyboard>


  <!-- Add Panel Button -->
  <!-- <div *ngIf="panels.length < maxPanels" (click)="addPanel()"
    class="flex items-center justify-center cursor-pointer btn-gradient-bg max-w-60 rounded-lg text-gray-400 hover:text-white hover:bg-slate-900 transition-colors">
    <button class="bet-panel__add-btn p-4 pb-5 text-4xl font-thin">
      +
    </button>
  </div> -->
  
</div>
